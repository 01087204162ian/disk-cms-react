# 주민번호 암호화 프로젝트 작업 재개 가이드

**작성일**: 2026-01-17  
**목적**: 작업 중단 후 재개 시 필요한 정보 및 다음 단계 안내

---

## 📋 현재 진행 상황

### ✅ 완료된 작업

1. **환경 변수 설정**
   - ✅ `.env` 파일 생성 (`/pci0327/www/.env`)
   - ✅ `JUMIN_ENCRYPTION_KEY` 설정 완료 (64자리 hex)
   - ✅ 파일 권한 설정 (600)

2. **보안 모듈 개발**
   - ✅ `pci0327/api/utils/jumin-secure.php` 생성
   - ✅ 암호화/복호화 함수 구현
   - ✅ 해시 생성 함수 구현
   - ✅ 마스킹 함수 구현

3. **테스트**
   - ✅ 테스트 스크립트 생성 (`test-jumin-secure.php`)
   - ✅ 모든 단위 테스트 통과

### 📝 다음 작업

1. **새 테이블 생성** ✅
   - [x] `2012DaeriMemberSecure` 테이블 생성
   - [x] 테이블 구조 확인
   - [x] 인덱스 생성

2. **API 수정** 🔄 (현재 진행 중)
   - [ ] 저장 API 수정 (암호화 적용)
   - [ ] 조회 API 수정 (복호화 및 마스킹)
   - [ ] 검색 API 수정 (해시 기반 검색)

3. **마이그레이션**
   - [ ] 기존 데이터 마이그레이션 스크립트 실행
   - [ ] 데이터 검증

---

## 🚀 작업 재개 방법

### 1단계: 현재 상태 확인

#### 서버 접속 및 환경 확인
```bash
# 서버 접속
ssh pci0327@uws8-wpm-079
cd /pci0327/www

# .env 파일 확인
cat .env
# 또는
grep JUMIN_ENCRYPTION_KEY .env

# 보안 모듈 파일 확인
ls -la api/utils/jumin-secure.php
ls -la api/utils/test-jumin-secure.php
```

#### 테스트 재실행 (선택 사항)
```bash
# 웹 브라우저에서
http://pcikorea.com/api/utils/test-jumin-secure.php

# 또는 curl로
curl http://pcikorea.com/api/utils/test-jumin-secure.php
```

**예상 결과**: 모든 테스트 통과 ✅

---

### 2단계: 관련 문서 확인

#### 필수 문서 목록
1. **기획 문서**: `disk-cms-react/docs/insurance/plans/2012DaeriMember-Jumin-암호화-기획.md`
   - 전체 프로젝트 개요
   - 테이블 구조 설계
   - 마이그레이션 전략

2. **환경 변수 설정 가이드**: `disk-cms-react/docs/insurance/plans/2012DaeriMember-Jumin-암호화-기획-환경변수-설정-가이드.md`
   - `.env` 파일 설정 방법
   - 키 생성 방법

3. **보안 모듈 완료 보고**: `disk-cms-react/docs/insurance/plans/보안모듈-개발-완료.md`
   - 완료된 작업 요약
   - 테스트 결과

#### 문서 위치
```
disk-cms-react/docs/insurance/plans/
├── 2012DaeriMember-Jumin-암호화-기획.md
├── 2012DaeriMember-Jumin-암호화-기획-환경변수-설정-가이드.md
├── 키-생성-빠른-가이드.md
├── 환경변수-설정-확인-가이드.md
├── 보안모듈-개발-완료.md
└── 작업-재개-가이드.md (이 문서)
```

---

### 3단계: 다음 작업 선택

#### 옵션 1: 새 테이블 생성 (권장)

**목표**: `2012DaeriMemberSecure` 테이블 생성

**참고 문서**: 
- `2012DaeriMember-Jumin-암호화-기획.md`의 "4. 새 테이블 설계" 섹션

**작업 내용**:
1. 테이블 생성 SQL 작성
2. 기존 `2012DaeriMember` 테이블 구조 확인
3. 새 테이블에 모든 필드 포함
4. 주민번호 필드는 `jumin_encrypted`, `jumin_hash`로 대체
5. 인덱스 생성

**SQL 예시** (기획 문서 참조):
```sql
CREATE TABLE `2012DaeriMemberSecure` (
  -- 기존 테이블의 모든 필드 포함
  `num` int(11) NOT NULL AUTO_INCREMENT,
  `Name` varchar(20) DEFAULT NULL,
  -- ... 기타 필드들 ...
  
  -- 보안 관련 필드
  `jumin_encrypted` text DEFAULT NULL,
  `jumin_hash` char(64) DEFAULT NULL,
  
  PRIMARY KEY (`num`),
  UNIQUE KEY `idx_jumin_hash` (`jumin_hash`),
  -- ... 기타 인덱스들 ...
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### 옵션 2: API 수정

**목표**: 주민번호 저장/조회/검색 API에 암호화 적용

**참고 문서**:
- `2012DaeriMember-Jumin-암호화-기획.md`의 "5. 구현 계획" 섹션

**작업 내용**:
1. 저장 API 수정 (`kj-driver-save.php` 등)
   - 주민번호 암호화
   - 해시 생성
   - 새 테이블에 저장

2. 조회 API 수정 (`kj-driver-list.php` 등)
   - 새 테이블에서 조회
   - 복호화 후 마스킹 처리

3. 검색 API 수정 (`kj-driver-search.php` 등)
   - 해시 기반 검색
   - LIKE 검색 제거

**수정 파일 목록**:
- `pci0327/api/insurance/kj-driver-list.php`
- `pci0327/api/insurance/kj-driver-save.php` (또는 관련 저장 API)
- `pci0327/api/insurance/kj-driver-search.php` (또는 관련 검색 API)

#### 옵션 3: 마이그레이션 스크립트 준비

**목표**: 기존 데이터 마이그레이션 스크립트 작성

**참고 문서**:
- `2012DaeriMember-Jumin-암호화-기획.md`의 "6. 마이그레이션 전략" 섹션

**작업 내용**:
1. 마이그레이션 스크립트 작성
2. 배치 처리 로직 구현
3. 에러 처리 및 롤백 로직

---

## 📝 작업 체크리스트

### Phase 1: 새 테이블 생성 ✅
- [x] 기존 `2012DaeriMember` 테이블 구조 확인
- [x] `2012DaeriMemberSecure` 테이블 생성 SQL 작성
- [x] 테스트 환경에서 테이블 생성
- [x] 테이블 구조 검증
- [x] 인덱스 생성

### Phase 2: API 수정
- [ ] 저장 API 수정
- [ ] 조회 API 수정
- [ ] 검색 API 수정
- [ ] 단위 테스트
- [ ] 통합 테스트

### Phase 3: 마이그레이션
- [ ] 마이그레이션 스크립트 작성
- [ ] 테스트 데이터로 마이그레이션 테스트
- [ ] 실제 데이터 마이그레이션 실행
- [ ] 데이터 검증

---

## 🔍 문제 해결

### 문제 1: .env 파일을 찾을 수 없음
**해결**: 파일 위치 확인
```bash
# 서버에서
cd /pci0327/www
ls -la .env

# 경로 확인
pwd
```

### 문제 2: 보안 모듈 로드 실패
**해결**: 파일 존재 확인
```bash
# 서버에서
ls -la /pci0327/www/api/utils/jumin-secure.php

# 경로 확인
cat api/utils/jumin-secure.php | head -20
```

### 문제 3: 테스트 실패
**해결**: 테스트 재실행 및 오류 확인
```bash
# 웹 브라우저에서 테스트
http://pcikorea.com/api/utils/test-jumin-secure.php

# 오류 로그 확인
tail -f /var/log/php_errors.log
```

---

## 📞 도움이 필요한 경우

### 참고 문서
1. **기획 문서**: `2012DaeriMember-Jumin-암호화-기획.md`
2. **환경 변수 가이드**: `2012DaeriMember-Jumin-암호화-기획-환경변수-설정-가이드.md`
3. **보안 모듈 완료 보고**: `보안모듈-개발-완료.md`

### 주요 코드 위치
- **보안 모듈**: `pci0327/api/utils/jumin-secure.php`
- **테스트 스크립트**: `pci0327/api/utils/test-jumin-secure.php`
- **환경 변수**: `/pci0327/www/.env`

### 주요 함수
- `encryptJumin($jumin)` - 주민번호 암호화
- `decryptJumin($encrypted)` - 주민번호 복호화
- `hashJumin($jumin)` - 해시 생성
- `maskJumin($jumin, $isEncrypted)` - 마스킹 처리

---

## ✅ 빠른 시작 체크리스트

작업 재개 시 다음 순서로 확인하세요:

1. [ ] 서버 접속 확인
2. [ ] `.env` 파일 존재 확인
3. [ ] 보안 모듈 파일 존재 확인
4. [ ] 테스트 스크립트 실행 확인
5. [ ] 기획 문서 확인
6. [ ] 다음 작업 선택 (테이블 생성 / API 수정 / 마이그레이션)

---

**작성일**: 2026-01-17  
**최종 업데이트**: 2026-01-17
