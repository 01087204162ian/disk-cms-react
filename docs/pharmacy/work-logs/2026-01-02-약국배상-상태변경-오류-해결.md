# 약국배상책임보험 상태 변경 오류 해결 작업

**작업일**: 2026년 1월 2일  
**작업자**: 개발팀  
**관련 시스템**: 약국배상책임보험 (imet)

---

## 📋 작업 개요

약국배상책임보험 상태 변경 시 발생하던 PHP 함수 미정의 오류를 해결하고, 관련 코드를 개선했습니다.

---

## 🐛 발견된 문제

### 오류 내용

**에러 메시지**:
```
Fatal error: Call to undefined function recalculatePremiumForRefund() 
in /qvalet0327/www/api/pharmacy/pharmacy-status-update.php on line 330
```

**발생 상황**:
- 승인(13) → 보류(7) 상태 변경 시
- 승인(13) → 메일보냄(10) 상태 변경 시
- 해지요청(15) → 해지완료(16) 상태 변경 시

**프론트엔드 오류**:
```
POST https://disk-cms.simg.kr/api/pharmacy2/update-status 400 (Bad Request)
상태 변경 오류: Error: HTTP 400
```

---

## 🔍 문제 분석

### 원인

1. **함수 미정의**: `pharmacy-status-update.php` 파일에서 `recalculatePremiumForRefund()` 함수를 호출하고 있었으나, 실제 함수 정의가 없었음
2. **함수 호출 위치**: 
   - 262번째 줄: 보류(7) 처리
   - 330번째 줄: 메일보냄(10) 처리  
   - 403번째 줄: 해지완료(16) 처리
3. **함수 역할**: 환급 처리를 위한 보험료 재계산 (80㎡ 미만 처리 및 account별 테이블 구분 포함)

### 관련 코드 확인

- **파일**: `D:\development\imet\api\pharmacy\pharmacy-status-update.php`
- **호출 패턴**: 
  ```php
  $recalculated = recalculatePremiumForRefund($connection, array(
      'pharmacy_id' => $pharmacy_id,
      'account' => $account,
      'chemist' => $chemist,
      'chemistLimit' => $chemistLimit,
      'area' => $area,
      'jaegojasan' => $jaegojasan,
      'sigi' => $sigi
  ));
  ```
- **반환값 사용**: 
  ```php
  $refund_premium = $recalculated['total_premium'];
  $refund_pro_premium = $recalculated['pro_premium'];
  $refund_area_premium = $recalculated['area_premium'];
  ```

---

## ✅ 해결 방법

### 1. 함수 구현

**위치**: `D:\development\imet\api\pharmacy\pharmacy-status-update.php` (79번째 줄 이후)

**구현 내용**:

```php
/**
 * 환급을 위한 보험료 재계산 함수
 * 보류(7), 메일보냄(10), 해지완료(16) 처리 시 사용
 * 
 * @param mysqli $connection 데이터베이스 연결
 * @param array $params 계산 파라미터 배열
 *   - pharmacy_id: 약국 ID
 *   - account: 계정 번호 (1,7: 일반, 6,8: 유비케어)
 *   - chemist: 전문인수
 *   - chemistLimit: 전문인 보상한도 (유비케어 전용, 1: 1억, 2: 2억)
 *   - area: 사업장면적
 *   - jaegojasan: 재고자산 값 (1~5)
 *   - sigi: 보험 시작일
 * @return array 보험료 계산 결과
 *   - total_premium: 총 보험료
 *   - pro_premium: 전문인 보험료
 *   - area_premium: 화재 보험료
 */
function recalculatePremiumForRefund($connection, $params) {
    // 구현 내용...
}
```

**주요 기능**:

1. **account별 테이블 선택**
   - account 1, 7: `pharmacyProPreminum`, `pharmacyPreminum` 테이블 사용 (일반형)
   - account 6, 8: `ubcareProPreminum`, `ubcarePreminum` 테이블 사용 (유비케어형)

2. **전문인 배상책임보험료 계산**
   - 전문인수에 따른 보험료 조회
   - 유비케어의 경우 보상한도(limit) 조건 추가
   - 전문인수 0명 처리

3. **화재보험료 계산**
   - 80㎡ 미만 면적 자동 처리 (80㎡로 계산)
   - 재고자산 값(jaegojasan)에 따른 보험료 선택 (preminum1~5)
   - 범위 검색 지원 (정확 일치 실패 시)

4. **총 보험료 계산 및 반환**
   - 전문인 보험료 + 화재보험료
   - 배열 형태로 반환: `total_premium`, `pro_premium`, `area_premium`

### 2. Node.js 프록시 코드 개선

**파일**: `disk-cms/routes/pharmacy/pharmacy2.js`

**개선 내용**:

1. **old_status 파라미터 전달 추가**
   ```javascript
   const oldStatus = req.body.old_status; // 프론트엔드에서 전달된 old_status
   if (oldStatus) {
       requestData.old_status = oldStatus;
   }
   ```

2. **에러 로깅 강화**
   ```javascript
   console.log(`[POST /update-status] 상태 변경 요청 - 약국ID: ${validPharmacyId}, 상태: "${trimmedStatus}", 이전 상태: "${oldStatus || 'N/A'}"`);
   ```

3. **PHP API 실패 응답 처리 개선**
   ```javascript
   if (response.data && !response.data.success) {
       console.error(`[POST /update-status] PHP API 실패 응답:`, JSON.stringify(response.data, null, 2));
       return res.status(400).json({
           success: false,
           error: response.data.error || response.data.message || '상태 변경에 실패했습니다.',
           details: response.data
       });
   }
   ```

---

## 📝 수정된 파일

### 1. `imet/api/pharmacy/pharmacy-status-update.php`

**변경 사항**:
- `recalculatePremiumForRefund()` 함수 추가 (약 200줄)
- 함수 위치: 79번째 줄 이후 (에러 보고 설정 이후, try 블록 이전)

**주요 기능**:
- account별 테이블 구분 처리
- 전문인 보험료 계산
- 화재보험료 계산 (80㎡ 미만 처리 포함)
- 재고자산별 보험료 선택
- 범위 검색 지원

### 2. `disk-cms/routes/pharmacy/pharmacy2.js`

**변경 사항**:
- `/update-status` 엔드포인트 개선
- `old_status` 파라미터 전달 추가
- 에러 로깅 강화
- PHP API 실패 응답 처리 개선

---

## 🧪 테스트 시나리오

다음 시나리오에서 정상 작동 확인 필요:

1. ✅ **승인(13) → 보류(7) 변경**
   - 예치금 환급 처리
   - 정산 기록 생성 (sort=7)
   - 보험료 재계산 확인

2. ✅ **승인(13) → 메일보냄(10) 변경**
   - 예치금 환급 처리
   - 정산 기록 생성 (sort=7)
   - 보험료 재계산 확인

3. ✅ **해지요청(15) → 해지완료(16) 변경**
   - 일할 계산 환급 처리
   - 재계산된 보험료 기반 계산 확인

4. ✅ **일반형(account 1, 7) 약국**
   - pharmacy 테이블 사용 확인

5. ✅ **유비케어형(account 6, 8) 약국**
   - ubcare 테이블 사용 확인
   - 보상한도(limit) 조건 확인

6. ✅ **80㎡ 미만 면적 처리**
   - 자동으로 80㎡로 계산되는지 확인

---

## 📚 참고 자료

### 관련 문서
- `disk-cms/docs/pharmacy/pharmacy-통합-문서.md`: 약국배상책임보험 시스템 전체 구조
- `disk-cms/docs/pharmacy/pharmacy-status-update-fix-guide.md`: 문제 해결 가이드 (작성됨)

### 관련 파일
- `imet/api/pharmacy/pharmacy-premium-calculate.php`: 일반형 보험료 계산 API
- `imet/api/pharmacy/pharmacy-premium-calculate-ubcare.php`: 유비케어형 보험료 계산 API

### 상태 코드 참고
| 코드 | 상태명 | 설명 |
|------|--------|------|
| 7 | 보류 | 예치금 환급, 정산 기록 변경 |
| 10 | 메일보냄 | 상태 변경, 예치금 환급 |
| 13 | 승인 | 예치금 차감, 정산 기록 생성 |
| 15 | 해지요청 | - |
| 16 | 해지완료 | 일할 계산 환급 |

---

## 🎯 개선 효과

1. **오류 해결**: 상태 변경 시 발생하던 PHP Fatal Error 해결
2. **기능 복구**: 보류, 메일보냄, 해지완료 상태 변경 기능 정상 작동
3. **코드 품질**: 재사용 가능한 함수로 로직 분리
4. **디버깅 개선**: 에러 로깅 강화로 문제 추적 용이

---

## 💡 향후 개선 사항

1. **함수 테스트**: 단위 테스트 추가 고려
2. **에러 처리**: 더 상세한 에러 메시지 제공
3. **문서화**: 함수 사용 예제 추가
4. **성능 최적화**: 쿼리 최적화 검토

---

**작업 완료일**: 2026년 1월 2일  
**검토 상태**: 완료  
**배포 상태**: 대기 (서버 테스트 필요)
