# 약국안심보험 고객사 어드민 시스템 v2 작업 내역

**작성일**: 2025-01-XX  
**작업자**: 개발팀

---

## 작업 개요

고객사 어드민 시스템 v2 (`imet/hi/v2/`)의 구내치료비 보상한도를 account 값에 따라 동적으로 표시하도록 개선

---

## 변경 사항

### 1. 구내치료비 보상한도 동적 표시 기능 추가

**문제**: 대시보드의 보험 상품 정보 테이블에서 구내치료비 보상한도가 고정값으로 표시됨

**요구사항**: account 값에 따라 다르게 표시
- **크레소티** (account 1, 7): 1인당 50만원 / 1사고당 100만원
- **유비케어** (account 6, 8): 1인당 100만원 / 1사고당 300만원

**해결**:

#### 1.1 HTML 수정 (`dashboard.html`)

구내치료비 보상한도 셀에 `id` 추가:

```html
<td id="treatmentFeeCoverage" class="coverage-amount">100만원/1인당<br>300만원/1사고당</td>
```

#### 1.2 JavaScript 함수 추가 (`basic.js`)

**새로운 함수 추가**: `setTreatmentFeeCoverage()`

**주요 로직**:
1. `getUserInfo()`로 사용자 정보 조회
2. `account` 값 확인
3. account 값에 따라 보상한도 텍스트 동적 변경

**코드 위치**: `imet/hi/v2/js/basic.js`

**함수 내용**:
```javascript
function setTreatmentFeeCoverage() {
    const userInfo = getUserInfo();
    const coverageElement = document.getElementById('treatmentFeeCoverage');
    
    // account 값 확인
    let account = null;
    if (userInfo) {
        if (userInfo.account !== undefined && userInfo.account !== null) {
            account = String(userInfo.account);
        }
        // directory 값으로도 판단 가능 (백업)
        else if (userInfo.directory === 'ubcare') {
            account = 'ubcare';
        } else if (userInfo.directory === 'pharmacy') {
            account = 'pharmacy';
        }
    }
    
    // account 값에 따라 보상한도 설정
    if (account === '1' || account === '7' || account === 'pharmacy') {
        coverageElement.innerHTML = '50만원/1인당<br>100만원/1사고당';
    } else if (account === '6' || account === '8' || account === 'ubcare') {
        coverageElement.innerHTML = '100만원/1인당<br>300만원/1사고당';
    } else {
        // 기본값(유비케어) 사용
        coverageElement.innerHTML = '100만원/1인당<br>300만원/1사고당';
    }
}
```

**초기화 함수 수정**: `initializeApp()` 함수에 호출 추가

```javascript
function initializeApp() {
    // ...
    setTreatmentFeeCoverage();  // 추가
    // ...
}
```

#### 1.3 로그인 API 수정 (`login_v2.php`)

**문제**: `pharmacy_idList` 테이블에 `account` 필드가 없어서 SQL 쿼리 오류 발생

**해결**:
- SQL 쿼리에서 `account` 필드 제거
- 응답에서 `num` 값을 `account`로 반환 (pharmacy_idList.num이 pharmacyApply.account와 연결됨)

**수정 내용**:
```php
// SQL 쿼리 (account 필드 제거)
$sql = "SELECT num, mem_id, passwd, ch, directory, name, 메일, hphone1, api_key, api_secret 
        FROM pharmacy_idList WHERE mem_id = :mem_id LIMIT 1";

// 응답 (num 값을 account로 사용)
successResponse(array(
    'user_num' => $user['num'],
    'user_name' => $user['name'],
    'user_id' => $user['mem_id'],
    'phone' => $user['hphone1'],
    'ch' => $user['ch'],
    'directory' => $user['directory'],
    'account' => $user['num'],  // num 값이 account 역할
    'login_time' => $_SESSION['login_time'],
    'api_key' => $user['api_key'],
    'api_secret' => $user['api_secret']
), '로그인에 성공했습니다.');
```

---

## 수정된 파일 목록

1. `imet/hi/v2/dashboard.html`
   - 구내치료비 보상한도 셀에 `id="treatmentFeeCoverage"` 추가

2. `imet/hi/v2/js/basic.js`
   - `setTreatmentFeeCoverage()` 함수 추가
   - `initializeApp()` 함수에 호출 추가

3. `imet/hi/v2/api/login_v2.php`
   - SQL 쿼리에서 `account` 필드 제거
   - 응답에서 `num` 값을 `account`로 반환

---

## 동작 방식

1. 사용자가 로그인
2. `login_v2.php`에서 사용자 정보 조회 및 반환 (num 값을 account로 포함)
3. `sessionStorage`에 사용자 정보 저장
4. `dashboard.html` 로드 시 `initializeApp()` 실행
5. `setTreatmentFeeCoverage()` 함수 실행
6. 사용자 `account` 값 확인:
   - 크레소티 (1, 7): 50만원/1인당, 100만원/1사고당
   - 유비케어 (6, 8): 100만원/1인당, 300만원/1사고당
7. 테이블의 구내치료비 보상한도 업데이트

---

## 테스트 필요 사항

1. ✅ 크레소티 계정 (account 1, 7) 로그인 시 구내치료비 보상한도가 50만원/1인당, 100만원/1사고당으로 표시되는지 확인
2. ✅ 유비케어 계정 (account 6, 8) 로그인 시 구내치료비 보상한도가 100만원/1인당, 300만원/1사고당으로 표시되는지 확인
3. ✅ 로그인 API가 정상 작동하는지 확인 (SQL 오류 해결)
4. ✅ account 값이 없는 경우 기본값(유비케어)으로 표시되는지 확인

---

## 참고 사항

### 테이블 구조

- `pharmacy_idList` 테이블에는 `account` 필드가 없음
- `pharmacy_idList.num` 값이 `pharmacyApply.account`와 연결됨
- 따라서 `pharmacy_idList.num` 값을 `account`로 사용

### account 값 매핑

- **크레소티**: account = 1 또는 7
- **유비케어**: account = 6 또는 8
- **directory 값**: `pharmacy` = 크레소티, `ubcare` = 유비케어 (백업 판단 기준)

---

**문서 버전**: 1.0  
**최종 업데이트**: 2025-01-XX
